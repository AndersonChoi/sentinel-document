# DBAgent
원본 DB의 테이블을 DIC 클러스터로 연동하기 위하여 사용하는 방법 중 하나 입니다. 지정된 FTP Landing 서버에 미리 정의된 파일 이름으로 파일을 전달해 주셔야 합니다. 그리고 FTP 서버에 전달된 파일을 주기적으로 확인한 후 파일을 DIC 클러스터에 적재합니다.

## 장점
* 데이터를 파일 단위로 다루므로 추출에 문제가 없었다면 전송 과정에서 중복 레코드가 발생하지 않습니다.

## 제약 사항
* 데이터 추출 및 파일 전달을 입수 요청 팀에서 진행해야 합니다. 추출 시 기본적인 변환, 클랜징 작업도 진행해야 합니다.
* DIC 클러스터 적재 작업도 배치이므로 파일 전달이 예정 시간보다 늦어지거나 재추출해야할 때에는 수동으로 적재하도록 DI팀에 요청해야 합니다. (매우 불편합니다.)

## 신청 절차
1. 연동 요청자는 BM별로 DE팀 담당자와 컨택하여 연동해야할 원본 DB의 테이블을 지정합니다.
2. 연동 방법이 DBAgent로 결정되면 DICc-t5if002 (172.22.212.92) 서버 쪽 FTP 포트 (21) 방화벽을 신청합니다.
3. 연동 요청자는 [DI팀 JIRA 고객센터](http://jira.skplanet.com/servicedesk/customer/portal/49) 를 통해 신규 데이터 입수를 요청합니다. DI팀과 상의해 [센티넬](http://sentinel.skplanet.com:8080)에서 인터페이스 정의서를 작성할 프로젝트를 지정, 인터페이스 정의서를 (추가) 작성합니다.
    * [센티넬 프로젝트 작성 메뉴얼](http://sentinel.skplanet.com:8080/docs/dbschema)
4. DI팀은 FTP 계정을 준비합니다.
5. 연동 요청자는 테이블 추출 & 전송 앱을 개발 & 운영합니다.
6. DI팀은 센티넬 프로젝트 내 인터페이스 정의서를 참고해 배치 잡을 등록합니다.

## 파일 생성 가이드
* 파일 명은 주기별로 생성되도록 아래 형태로 생성합니다.
    - [DATA_ID]_[추출기준일자].tsv
    - 추출기준일자는 통계 도출 시 기준이 되는 일자를 말합니다.
    - 예를들면 20160616일자 구매 내역 통계를 도출하기 위해 20160616 구매 이력을 추출할 때 파일 명에 20160616 값을 넣어주시면 됩니다.
* tsv 포멧: 필드 구분자 탭 ("\t"), 레코드 구분자 개행문자 ("\n") 형태로 생성합니다.
* 필드 내 개행문자 ("\n"), 탭 ("\t") 제거해주십시오.
* 추출 유형에 따른 레코드 필터링
    - full (전체)
        + 테이블 전체 추출합니다.
    - delta (변동분)
        + 레코드 생성 일자 & 업데이트 일자 필드가 있을 경우 두 필드 중 하나라도 값이 D-1인 레코드만 추출합니다.
    - incremental (증분)
        + 레코드 생성 일자 필드가 있을 경우 필드 값이 D-1인 레코드만 추출합니다.
* 암호화된 필드 중 분석에 필요한 경우 복호화
    - DIC 적재 시 DIC 암호화 방식으로 다시 암호화됩니다.
* date 타입의 포멧은 ISO 8601 사용을 권장합니다.
* null 값은 empty string ("")으로 치환해주십시오.

## 생성되는 테이블
* DIC 클러스터 하이브에 생성되는 테이블은 기본적으로 
    - 인터페이스 정의서에 암호화 요청된 필드는 DIC 규격대로 암호화되어 적재됩니다. 복호화가 필요할 경우 [위키 가이드 페이지](http://wiki.skplanet.com/pages/viewpage.action?pageId=55452400)를 참고하세요.
    - 추출 주기마다 새로운 파티션이 생성되며 테이블의 모든 레코드가 새 파티션에 적재됩니다. 따라서 테이블 사용 시 파티션 하나만 지정해서 조회하시면 됩니다.