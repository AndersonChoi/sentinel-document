# LogAgent

로그 파일 입수 프로그램<br/>
지정된 디렉토리 내 파일을 모니터링하여 증분에 대해 kafka 전송<br/>
(신규 로그 입수시 RakeAPI 권장, 예외적인 경우에만 사용)<br/>

## db-data 입수용으로 사용 시
원본 DB의 테이블을 DIC 클러스터로 연동하기 위하여 사용하는 방법 중 하나 입니다. 합의된 Landing 서버에 미리 정의된 파일 이름으로 파일을 생성해주셔야 합니다. 그리고 Landing 서버에 LogAgent 데몬을 띄워 파일을 DIC 클러스터에 적재합니다.

### 장점
* LogAgent가 디렉토리를 모니터링하고 있기 때문에 예정 시간보다 늦거나 빨리 파일을 생성하더라도 별도의 대응이 필요 없습니다.

### 제약 사항
* 데이터 추출 및 파일 생성을 입수 요청 팀에서 진행해야 합니다. 추출 시 기본적인 변환, 클랜징 작업도 진행해야 합니다.
* 테이블 스키마 외에 첫번째 필드에 추출기준일자 메타 필드를 붙여야 합니다.
    - 자세한 설명은 아래 파일 생성 가이드 참조
* 추출에 문제가 있어 파일을 재추출해야할 때에는 DIC 클러스터에 전송된 파일을 먼저 삭제하도록 DI팀에 요청한 후 작업해야 합니다. (매우 불편합니다.) DI팀에서 조치해주지 않고 파일을 재생성하면 중복 레코드가 발생합니다.

### 신청 절차
1. 연동 요청자는 BM별로 DE팀 담당자와 컨택하여 연동해야할 원본 DB의 테이블을 지정합니다.
2. 연동 방법이 LogAgent로 결정되면 Landing 서버를 준비합니다.
3. 연동 요청자는 [DI팀 JIRA 고객센터](http://jira.skplanet.com/servicedesk/customer/portal/49) 를 통해 신규 데이터 입수를 요청합니다. DI팀과 상의해 [센티넬](http://sentinel.skplanet.com:8080)에서 인터페이스 정의서를 작성할 프로젝트를 지정, 인터페이스 정의서를 (추가) 작성합니다.
    * [센티넬 프로젝트 작성 메뉴얼](http://sentinel.skplanet.com:8080/docs/dbschema)
4. 연동 요청자는 테이블 추출 앱을 개발 & 운영합니다.
5. DI팀은 센티넬 프로젝트 내 인터페이스 정의서를 참고해 Landing 서버에 LogAgent 설치 및 데몬을 관리합니다.

### 추출 파일 생성 가이드
* 파일 명은 주기별로 생성되도록 아래 형태로 생성합니다.
    - [DATA_ID]_[추출기준일자].tsv
* tsv 포멧: 필드 구분자 탭 ("\t"), 레코드 구분자 개행문자 ("\n") 형태로 생성합니다.
* 필드 내 개행문자 ("\n"), 탭 ("\t") 제거해주십시오.
* 모든 레코드의 첫번째 필드에 추출기준일자 추가
    - 추출기준일자는 통계 도출 시 기준이 되는 일자를 말합니다.
    - 예를들면 20160616일자 구매 내역 통계를 도출하기 위해 20160616 구매 이력을 추출할 때, 추출하는 모든 레코드의 첫번째 필드에 20160616 값을 넣어주시면 됩니다.
    - 추출 작업은 자정 이후에 이루어 지므로 추출 시점 기준 D-1 값을 넣어주시면 됩니다. (20160617일에 20160616 레코드를 추출)
* 추출 유형에 따른 레코드 필터링
    - full (전체)
        + 테이블 전체 추출합니다.
    - delta (변동분)
        + 레코드 생성 일자 & 업데이트 일자 필드가 있을 경우 두 필드 중 하나라도 값이 D-1인 레코드만 추출합니다.
    - incremental (증분)
        + 레코드 생성 일자 필드가 있을 경우 필드 값이 D-1인 레코드만 추출합니다.
* 암호화된 필드 중 분석에 필요한 경우 복호화
    - DIC 적재 시 DIC 암호화 방식으로 다시 암호화됩니다.

* date 타입의 포멧은 ISO 8601 사용을 권장합니다.
* null 값은 empty string ("")으로 치환해주십시오.

### 생성되는 테이블
* DIC 클러스터 하이브에 생성되는 테이블은 기본적으로 
    - 인터페이스 정의서에 암호화 요청된 필드는 DIC 규격대로 암호화되어 적재됩니다. 북호화가 필요할 경우 [위키 가이드 페이지](http://wiki.skplanet.com/pages/viewpage.action?pageId=55452400)를 참고하세요.
    - 추출 주기마다 새로운 파티션이 생성되며 테이블의 모든 레코드가 새 파티션에 적재됩니다. 따라서 테이블 사용 시 파티션 하나만 지정해서 조회하시면 됩니다.